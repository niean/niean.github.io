---
layout: post
title: 配管在私有云环境遇到的问题
date: 2018-04-01 11:00
tags:
  - thoughts
---

## 导读
本文讨论了**配置管理从物理机过渡到私有云时遇到的问题和解决思路**。

## 背景
私有docker容器环境(下文简称为弹性云)在发布、回滚、漂移时，容器会销毁重建，容器上配置数据会被销毁。

目前常用的物理机模式的配置下发，以 用户单次触发 为主。比如，发一个部署单子等。

如果配置下发期间容器正好被重建，该容器的这次配置发下的正常流程会失败；如果重试时间跨度小于 容器启动耗时，配置下发的重试策略也会失败。这样，当容器启动完成后，配置数据可能会遗漏掉最新的配置。

另一个常见的决策难题是，重建的容器应该使用哪一次触发对应的配置，无论选择"最新生效中"还是"最后一次成功"都会有问题：最新生效中的配置 有正确性问题（最新的配置不正确、被回滚了），最后一次成功有最新配置无法生效的问题。

## 问题分析
上述问题，主要有两个关键点:

- 缺乏配置最终一致性的保证手段（触发式的通病）
- 缺乏明确的配置定义，即 "容器应该使用哪一版本的配置"

上述两个问题，在物理机时代也存在。因为物理机销毁重建的机会少很多，所以问题一般不太严重。

## 云上新特征
结合上述问题，以及长期积累下来的优秀实践经验，相比于物理机时代云上配置管理应该具备如下特征:

- 保证配置最终一致性
- 明确的配置定义
- 支持配置的分级发布
- 配置关联到服务集群

其中，分级发布和配置定义分别代表了推拉模式，如何保障配置最终正确性是产品设计时应该重点考虑的事项。

